{% extends "layout.html" %}

{% block title %}ShrekChat - Messages{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', path='css/chat.css') }}">
{% endblock %}

{% block content %}
<!-- Main Chat Interface Container -->
<div class="chat-container">
    <!-- Sidebar with contacts -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="burger-menu" id="profileButton">
                <i class="fas fa-bars"></i>
            </div>
            <div class="sidebar-actions">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search" />
                </div>
            </div>
        </div>
        <div class="contacts-list" id="contactsList">
            <!-- Contacts will be loaded dynamically -->
            <div class="no-contacts-message" id="noContactsMessage">
                <p>No contacts yet. Add friends to start chatting!</p>
            </div>
        </div>
    </div>

    <!-- Main chat area -->
    <div class="chat-area">
        <!-- Welcome message for when no chat is selected -->
        <div class="welcome-container" id="welcomeContainer">
            <img src="{{ url_for('static', path='images/shrek-logo.png') }}" alt="ShrekChat Logo" />
            <h2>Welcome to ShrekChat</h2>
            <p>Select a contact to start chatting</p>
        </div>

        <!-- Chat content - will be hidden when no chat is selected -->
        <div class="chat-content" id="chatContent" style="display: none">
            <div class="chat-header">
                <div class="chat-contact-info">
                    <div class="contact-avatar">
                        <img src="{{ url_for('static', path='images/donkey.jpg') }}" alt="Donkey" />
                        <span class="status online"></span>
                    </div>
                    <div>
                        <div class="contact-name">Donkey</div>
                        <div class="contact-status">Online</div>
                    </div>
                </div>
                <div class="chat-actions">
                    <i class="fas fa-phone"></i>
                    <i class="fas fa-video"></i>
                    <div class="dropdown">
                        <i class="fas fa-ellipsis-v dropdown-toggle"></i>
                        <div class="dropdown-menu">
                            <div class="dropdown-item" id="deleteAllMessages">
                                <i class="fas fa-trash"></i>
                                <span>Delete all messages</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="messages-container">
                <!-- Messages will be loaded dynamically -->
            </div>

            <div class="input-area">
                <i class="fas fa-paperclip"></i>
                <input
                    type="text"
                    placeholder="Type a message..."
                    id="messageInput"
                />
                <button type="button" class="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ======= SIDEBARS ======= -->
<!-- Profile sidebar -->
<div class="profile-sidebar" id="profileSidebar">
    <div class="profile-header">
        <div class="close-profile">
            <i class="fas fa-arrow-left"></i>
        </div>
        <h2>Settings</h2>
    </div>

    <div class="profile-content">
        <div class="profile-section">
            <div class="profile-picture">
                <img
                    src="{{ url_for('static', path='images/shrek-logo.png') }}"
                    alt="Profile Picture"
                    id="profilePicture"
                />
            </div>
            <div class="profile-name" id="profileName"></div>
            <div class="profile-status" id="profileStatus"></div>
        </div>

        <div class="profile-menu">
            <div class="menu-item">
                <i class="fas fa-user"></i>
                <span>My Profile</span>
            </div>
            <div class="menu-item">
                <i class="fas fa-users"></i>
                <span>New Group</span>
            </div>
            <div class="menu-item">
                <i class="fas fa-user-plus"></i>
                <span>Add Friend</span>
            </div>
            <div class="menu-item">
                <i class="fas fa-moon"></i>
                <span>Theme</span>
                <label class="theme-switch">
                    <input type="checkbox" id="themeToggle" />
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="menu-item">
                <i class="fas fa-user-friends"></i>
                <span>Invite Friends</span>
            </div>
            <div class="menu-item logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </div>
        </div>
    </div>
</div>

<!-- Overlay for when sidebar or popup is active -->
<div class="overlay" id="overlay"></div>

<!-- ======= POPUPS ======= -->
{% include 'popups/profile_edit.html' %}
{% include 'popups/add_friend.html' %}
{% include 'popups/group_management.html' %}
{% include 'popups/user_profile.html' %}
{% endblock %}

{% block scripts %}
<!-- Javascript block with template variables -->
<script>
    // Pass data from server to client using Jinja
    const SERVER_URL = "{{ server_url|default('http://localhost:8000') }}";
    const SOCKETIO_PATH = "{{ socketio_path|default('/socket.io/') }}";
    const USER_DATA = {{ user_data|default('{}')|safe }};
    const INITIAL_CONTACTS = {{ contacts|default('[]')|safe }};
    
    // This function is called when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user is logged in
        const token = localStorage.getItem('token') || USER_DATA.token;
        
        if (!token) {
            // Redirect to login page if not logged in
            window.location.href = "/api/auth/login";
            return;
        }
        
        // Store user data in localStorage if it came from the server
        if (USER_DATA && USER_DATA.token) {
            localStorage.setItem('token', USER_DATA.token);
            localStorage.setItem('user', JSON.stringify({
                username: USER_DATA.username,
                email: USER_DATA.email
            }));
        }
        
        // Initialize the chat interface
        initializeChat();
    });
    
    // Initialize the chat interface
    function initializeChat() {
        // Create Socket.IO connection with authentication
        const socket = io(SERVER_URL, {
            path: SOCKETIO_PATH,
            transports: ['websocket'],
            reconnection: true,
            reconnectionAttempts: 5
        });
        
        // Socket.IO connection events
        socket.on('connect', () => {
            console.log('Connected to Socket.IO server');
            
            // Authenticate with the server
            const token = localStorage.getItem('token');
            socket.emit('authenticate', { token });
        });
        
        // Socket.IO authentication events
        socket.on('auth_success', (data) => {
            console.log('Authentication successful:', data);
            document.querySelector('.profile-status').textContent = 'Online';
        });
        
        socket.on('auth_error', (data) => {
            console.error('Authentication error:', data);
            alert('Authentication failed. Please login again.');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = "/api/auth/login";
        });
        
        // Handle incoming messages
        socket.on('new_message', (message) => {
            console.log('New message received:', message);
            
            // Display the message if it's from the current contact
            const currentContact = getCurrentContact();
            
            const isCurrentConversation = (
                (currentContact === message.sender) ||
                (currentContact === message.receiver && message.sender === getUserData().username)
            );
            
            if (isCurrentConversation) {
                appendMessageToChat(message);
                
                // Mark message as read
                if (message.sender !== getUserData().username) {
                    socket.emit('read_messages', {
                        message_ids: [message.id],
                        sender: message.sender
                    });
                }
            } else {
                // Update contact in sidebar with unread message
                updateContactWithUnreadMessage(message);
            }
        });
        
        // Handle message delivery confirmations
        socket.on('message_delivered', (data) => {
            console.log('Message delivered:', data);
            updateMessageStatus(data.message_id, 'delivered');
        });
        
        // Handle messages being read by the recipient
        socket.on('messages_read', (data) => {
            console.log('Messages read:', data);
            data.message_ids.forEach(id => updateMessageStatus(id, 'read'));
        });
        
        // Handle user status updates
        socket.on('user_status', (data) => {
            console.log('User status update:', data);
            updateUserStatus(data.username, data.status);
        });
        
        // Handle disconnect
        socket.on('disconnect', () => {
            console.log('Disconnected from Socket.IO server');
        });
        
        // Load contacts
        loadContacts();
        
        // Add event listeners for UI interactions
        setupEventListeners(socket);
    }
    
    // Get user data from localStorage
    function getUserData() {
        return JSON.parse(localStorage.getItem('user') || '{}');
    }
    
    // Get current contact
    function getCurrentContact() {
        return document.querySelector('.contact.active')?.dataset.username || null;
    }
    
    // Load contacts from API or use initial data from Jinja
    function loadContacts() {
        const contactsList = document.getElementById('contactsList');
        const token = localStorage.getItem('token');
        
        if (INITIAL_CONTACTS && INITIAL_CONTACTS.length > 0) {
            // Use initial contacts data from Jinja template
            displayContacts(INITIAL_CONTACTS);
        } else {
            // Fetch contacts from API
            fetch(`${SERVER_URL}/api/contacts/contacts`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.contacts && data.contacts.length > 0) {
                    displayContacts(data.contacts);
                } else {
                    document.getElementById('noContactsMessage').style.display = 'flex';
                }
            })
            .catch(error => {
                console.error('Error fetching contacts:', error);
                document.getElementById('noContactsMessage').style.display = 'flex';
            });
        }
    }
    
    // Display contacts in the sidebar
    function displayContacts(contacts) {
        const contactsList = document.getElementById('contactsList');
        const noContactsMessage = document.getElementById('noContactsMessage');
        
        // Clear any existing contacts
        contactsList.innerHTML = '';
        
        // Hide the no contacts message
        noContactsMessage.style.display = 'none';
        
        // Add each contact to the list
        contacts.forEach(contact => {
            const contactHTML = `
                <div class="contact" data-username="${contact.username}">
                    <div class="contact-avatar">
                        <img src="${contact.profilePicture || '{{ url_for('static', path='images/shrek-logo.jpg') }}'}" alt="${contact.username}">
                        <span class="status ${contact.status?.toLowerCase() === 'online' ? 'online' : 'offline'}"></span>
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.username}</div>
                        <div class="contact-last-message">${contact.lastMessage || 'No messages yet'}</div>
                    </div>
                    <div class="contact-meta">
                        <div class="contact-time">${contact.lastMessageTime || ''}</div>
                        ${contact.unreadCount ? `<div class="unread-count">${contact.unreadCount}</div>` : ''}
                    </div>
                </div>
            `;
            
            contactsList.insertAdjacentHTML('beforeend', contactHTML);
        });
        
        // Add event listeners to contacts
        attachContactEventListeners();
    }
    
    // Helper functions for WebSocket chat
    function attachContactEventListeners() {
        const contacts = document.querySelectorAll('.contact');
        
        contacts.forEach(contact => {
            contact.addEventListener('click', function() {
                // Remove active class from all contacts
                contacts.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked contact
                this.classList.add('active');
                
                // Get contact username
                const contactName = this.dataset.username;
                
                // Update UI and load messages
                setActiveContact(contactName);
                
                // Remove unread count badge if exists
                const unreadBadge = this.querySelector('.unread-count');
                if (unreadBadge) {
                    unreadBadge.remove();
                }
            });
        });
    }
    
    function setActiveContact(contactName) {
        // Hide welcome container and show chat content
        document.getElementById('welcomeContainer').style.display = 'none';
        document.getElementById('chatContent').style.display = 'flex';
        
        // Update chat header
        updateChatHeader(contactName);
        
        // Load messages for this contact
        loadMessages(contactName);
    }
    
    function updateChatHeader(contactName) {
        document.querySelector('.chat-header .contact-name').textContent = contactName;
        
        // Find contact element to get status and avatar
        const contactElement = document.querySelector(`.contact[data-username="${contactName}"]`);
        if (contactElement) {
            const statusEl = contactElement.querySelector('.status');
            const avatarImg = contactElement.querySelector('.contact-avatar img');
            
            if (avatarImg) {
                document.querySelector('.chat-header .contact-avatar img').src = avatarImg.src;
            }
            
            if (statusEl) {
                const isOnline = statusEl.classList.contains('online');
                document.querySelector('.chat-header .status').className = `status ${isOnline ? 'online' : 'offline'}`;
                document.querySelector('.chat-header .contact-status').textContent = isOnline ? 'Online' : 'Offline';
            }
        }
    }
    
    function loadMessages(contactName) {
        const messagesContainer = document.querySelector('.messages-container');
        const token = localStorage.getItem('token');
        
        // Show loading indicator
        messagesContainer.innerHTML = `
            <div class="loading-indicator">
                <div class="spinner"></div>
                <p>Loading messages...</p>
            </div>
        `;
        
        // Fetch messages for this contact
        fetch(`${SERVER_URL}/api/chat/messages/${contactName}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            // Clear messages container
            messagesContainer.innerHTML = '';
            
            // Display messages
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(message => {
                    appendMessageToChat(message);
                });
                
                // Scroll to bottom
                scrollToBottom();
            }
        })
        .catch(error => {
            console.error('Error loading messages:', error);
            messagesContainer.innerHTML = `
                <div class="messages-error">
                    <p>Failed to load messages. Please try again.</p>
                </div>
            `;
        });
    }
    
    function appendMessageToChat(message) {
        const messagesContainer = document.querySelector('.messages-container');
        const currentUser = getUserData().username;
        const isOutgoing = message.sender === currentUser;
        
        const messageHTML = `
            <div class="message ${isOutgoing ? 'outgoing' : 'incoming'}" data-id="${message.id}">
                <div class="message-content">${escapeHtml(message.content)}</div>
                <div class="message-meta">
                    <span class="message-time">${formatMessageTime(message.timestamp)}</span>
                    ${isOutgoing ? `<span class="message-status ${message.read ? 'read' : 'delivered'}">
                        ${message.read ? 'read' : 'delivered'}
                    </span>` : ''}
                </div>
            </div>
        `;
        
        messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
        scrollToBottom();
    }
    
    function sendMessage(socket) {
        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();
        const receiver = getCurrentContact();
        
        if (!content || !receiver) return;
        
        // Create message object
        const message = {
            receiver: receiver,
            content: content,
            timestamp: new Date().toISOString()
        };
        
        // Send through Socket.IO
        socket.emit('message', message);
        
        // Clear input field
        messageInput.value = '';
        
        // Add message to UI with pending status
        const pendingMessage = {
            id: 'pending-' + Date.now(),
            sender: getUserData().username,
            receiver: receiver,
            content: content,
            timestamp: message.timestamp,
            read: false
        };
        
        appendMessageToChat(pendingMessage);
    }
    
    function updateMessageStatus(messageId, status) {
        const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
        if (messageElement) {
            const statusElement = messageElement.querySelector('.message-status');
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.className = `message-status ${status}`;
            }
        }
    }
    
    function updateContactWithUnreadMessage(message) {
        const contactName = message.sender;
        const contactElement = document.querySelector(`.contact[data-username="${contactName}"]`);
        
        if (contactElement) {
            // Update last message
            const lastMessageElement = contactElement.querySelector('.contact-last-message');
            if (lastMessageElement) {
                const messagePreview = message.content.length > 30 
                    ? message.content.substring(0, 27) + '...' 
                    : message.content;
                lastMessageElement.textContent = messagePreview;
            }
            
            // Update time
            const timeElement = contactElement.querySelector('.contact-time');
            if (timeElement) {
                timeElement.textContent = formatMessageTime(message.timestamp);
            }
            
            // Add or increment unread count
            let unreadBadge = contactElement.querySelector('.unread-count');
            if (unreadBadge) {
                const count = parseInt(unreadBadge.textContent) + 1;
                unreadBadge.textContent = count;
            } else {
                contactElement.querySelector('.contact-meta').insertAdjacentHTML(
                    'beforeend',
                    '<div class="unread-count">1</div>'
                );
            }
            
            // Move contact to top of list
            const contactsList = document.getElementById('contactsList');
            contactsList.insertBefore(contactElement, contactsList.firstChild);
        }
    }
    
    function updateUserStatus(username, status) {
        // Update contact in sidebar
        const contactElement = document.querySelector(`.contact[data-username="${username}"]`);
        if (contactElement) {
            const statusIndicator = contactElement.querySelector('.status');
            if (statusIndicator) {
                statusIndicator.className = `status ${status}`;
            }
        }
        
        // Update chat header if this is the active contact
        if (getCurrentContact() === username) {
            const headerStatus = document.querySelector('.chat-header .status');
            const headerStatusText = document.querySelector('.chat-header .contact-status');
            
            if (headerStatus) {
                headerStatus.className = `status ${status}`;
            }
            
            if (headerStatusText) {
                headerStatusText.textContent = status === 'online' ? 'Online' : 'Offline';
            }
        }
    }
    
    function setupEventListeners(socket) {
        // Send message on button click
        document.querySelector('.send-button').addEventListener('click', () => {
            sendMessage(socket);
        });
        
        // Send message on Enter key
        document.getElementById('messageInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(socket);
            }
        });
        
        // Delete all messages button
        document.getElementById('deleteAllMessages').addEventListener('click', () => {
            const contactName = getCurrentContact();
            if (!contactName) return;
            
            if (confirm(`Are you sure you want to delete all messages with ${contactName}?`)) {
                deleteAllMessages(contactName);
            }
        });
        
        // Profile sidebar toggle
        document.getElementById('profileButton').addEventListener('click', () => {
            document.getElementById('profileSidebar').classList.add('open');
            document.getElementById('overlay').classList.add('active');
        });
        
        // Close profile sidebar
        document.querySelector('.close-profile').addEventListener('click', () => {
            document.getElementById('profileSidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
        });
        
        // Overlay click
        document.getElementById('overlay').addEventListener('click', () => {
            document.getElementById('profileSidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
            
            // Close all popups
            document.querySelectorAll('.popup').forEach(popup => {
                popup.classList.remove('open');
            });
        });
        
        // Logout button
        document.querySelector('.menu-item.logout').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/api/auth/login';
        });
        
        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        
        // Apply saved theme on page load
        if (localStorage.getItem('darkTheme') === 'true') {
            document.body.classList.add('dark-theme');
            themeToggle.checked = true;
        }
        
        themeToggle.addEventListener('change', function() {
            if (this.checked) {
                document.body.classList.add('dark-theme');
                localStorage.setItem('darkTheme', 'true');
            } else {
                document.body.classList.remove('dark-theme');
                localStorage.setItem('darkTheme', 'false');
            }
        });
    }
    
    // Helper functions
    function scrollToBottom() {
        const messagesContainer = document.querySelector('.messages-container');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function formatMessageTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function deleteAllMessages(contactName) {
        const token = localStorage.getItem('token');
        
        fetch(`${SERVER_URL}/api/chat/delete-messages/${contactName}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            // Clear messages container
            document.querySelector('.messages-container').innerHTML = `
                <div class="system-message">
                    <p>${data.message || 'All messages deleted successfully'}</p>
                </div>
            `;
            
            // Update contact in sidebar
            const contactElement = document.querySelector(`.contact[data-username="${contactName}"]`);
            if (contactElement) {
                const lastMessageElement = contactElement.querySelector('.contact-last-message');
                if (lastMessageElement) {
                    lastMessageElement.textContent = 'No messages';
                }
            }
        })
        .catch(error => {
            console.error('Error deleting messages:', error);
            alert('Failed to delete messages. Please try again.');
        });
    }
</script>
{% endblock %}